{% extends 'invoice_management/base.html' %}

{% block title %}{{ title }} - 請求書管理システム{% endblock %}

{% block extra_css %}
<style>
/* 計算ボタンの透過問題を完全に修正 */
.btn-outline-secondary {
    background-color: #ffffff !important;
    border-color: #6c757d !important;
    color: #6c757d !important;
    opacity: 1 !important;
    z-index: 10 !important;
    position: relative !important;
}

.btn-outline-secondary:hover {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #ffffff !important;
    opacity: 1 !important;
}

.btn-outline-secondary:focus {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
    color: #ffffff !important;
    opacity: 1 !important;
    box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25) !important;
}

/* オートコンプリート入力フィールドのスタイル */
.company-autocomplete {
    position: relative;
}

.company-input {
    width: 100%;
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    font-size: 1rem;
    line-height: 1.5;
}

.company-input:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    outline: 0;
}

.company-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.suggestion-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item.active {
    background-color: #e9ecef;
    color: #495057;
}

/* ドロップダウンメニューのスタイル */
.dropdown-menu .company-option {
    white-space: normal;
    word-wrap: break-word;
}

.dropdown-menu .company-option:hover {
    background-color: #f8f9fa;
}

.input-group .dropdown-toggle {
    border-left: none;
}

.input-group .form-control:focus + .dropdown-toggle {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-file-invoice"></i> {{ title }}</h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-invoice-dollar"></i> 請求書情報入力
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.invoice_number.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-hashtag text-primary"></i> 請求書番号
                                </label>
                                {{ form.invoice_number }}
                                {% if form.invoice_number.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle"></i> {{ form.invoice_number.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-magic text-success"></i> 空白の場合は自動で連番が割り当てられます
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="company-input" class="form-label fw-bold">
                                    <i class="fas fa-building text-primary"></i> 取引先会社 <span class="text-danger">*</span>
                                </label>
                                <div class="company-autocomplete">
                                    <div class="input-group">
                                        <input type="text" id="company-input" class="form-control company-input" 
                                               placeholder="会社名またはコードを入力してください..." autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                id="company-dropdown-btn" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <ul class="dropdown-menu w-100" id="company-dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                                            {% for company in form.company.field.queryset %}
                                                <li><a class="dropdown-item company-option" href="#" data-id="{{ company.id }}" data-name="{{ company.name }}" data-code="{{ company.code }}">
                                                    <strong>{{ company.code }}</strong> - {{ company.name }}
                                                </a></li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div id="company-suggestions" class="company-suggestions"></div>
                                    {{ form.company.as_hidden }}
                                    <select id="company-select" style="display: none;">
                                        <option value="">取引先会社を選択してください</option>
                                        {% for company in form.company.field.queryset %}
                                            <option value="{{ company.id }}">{{ company.code }} - {{ company.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% if form.company.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle"></i> {{ form.company.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info"></i>
                                    取引先が見つからない場合は 
                                    <a href="{% url 'company_add' %}" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-external-link-alt"></i> こちらから追加
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.amount.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-yen-sign text-success"></i> 請求金額（税抜） <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.amount }}
                                </div>
                                {% if form.amount.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle"></i> {{ form.amount.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.tax_amount.id_for_label }}" class="form-label fw-bold">
                                    <i class="fas fa-percent text-info"></i> 消費税額
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    {{ form.tax_amount }}
                                    <button type="button" class="btn btn-outline-secondary" onclick="calculateTax()" title="10%を自動計算">
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                </div>
                                {% if form.tax_amount.errors %}
                                    <div class="text-danger small mt-1">
                                        <i class="fas fa-exclamation-circle"></i> {{ form.tax_amount.errors }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    <i class="fas fa-calculator text-info"></i> 計算ボタンで10%を自動計算
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-coins text-warning"></i> 総額（自動計算）
                                </label>
                                <input type="text" class="form-control bg-light fw-bold text-primary" id="total_display" readonly style="font-size: 1.1em;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.invoice_date.id_for_label }}" class="form-label">
                                    請求書日付 <span class="text-danger">*</span>
                                </label>
                                {{ form.invoice_date }}
                                {% if form.invoice_date.errors %}
                                    <div class="text-danger small">{{ form.invoice_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.due_date.id_for_label }}" class="form-label">
                                    支払期限 <span class="text-danger">*</span>
                                </label>
                                {{ form.due_date }}
                                {% if form.due_date.errors %}
                                    <div class="text-danger small">{{ form.due_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.payment_status.id_for_label }}" class="form-label">
                                    支払状況 <span class="text-danger">*</span>
                                </label>
                                {{ form.payment_status }}
                                {% if form.payment_status.errors %}
                                    <div class="text-danger small">{{ form.payment_status.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            摘要
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'invoice_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 戻る
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function calculateTax() {
    const amountField = document.getElementById('{{ form.amount.id_for_label }}');
    const taxField = document.getElementById('{{ form.tax_amount.id_for_label }}');
    
    const amount = parseFloat(amountField.value) || 0;
    const tax = Math.floor(amount * 0.1);
    
    taxField.value = tax;
    updateTotal();
}

function updateTotal() {
    const amountField = document.getElementById('{{ form.amount.id_for_label }}');
    const taxField = document.getElementById('{{ form.tax_amount.id_for_label }}');
    const totalDisplay = document.getElementById('total_display');
    
    const amount = parseFloat(amountField.value) || 0;
    const tax = parseFloat(taxField.value) || 0;
    const total = amount + tax;
    
    totalDisplay.value = '¥' + total.toLocaleString();
}

// オートコンプリート機能
function initializeCompanyAutocomplete() {
    console.log('Initializing company autocomplete...');
    const companyInput = document.getElementById('company-input');
    const companySuggestions = document.getElementById('company-suggestions');
    const companySelect = document.getElementById('company-select'); // 正しいIDを使用
    const companyHidden = document.getElementById('id_company');   // 隠しフィールド
    
    console.log('Elements found:', {
        companyInput: !!companyInput,
        companySuggestions: !!companySuggestions,
        companySelect: !!companySelect,
        companyHidden: !!companyHidden
    });
    
    if (companySelect) {
        console.log('Company select options:', companySelect.options.length);
    }
    
    let companies = [];
    let selectedIndex = -1;

    // 会社データを初期化
    function loadCompanies() {
        companies = [];
        console.log('Loading companies from select options...');
        if (!companySelect) {
            console.error('Company select element not found');
            return;
        }
        
        for (let i = 0; i < companySelect.options.length; i++) {
            const option = companySelect.options[i];
            if (option.value) {
                companies.push({
                    id: option.value,
                    name: option.textContent.trim(),
                    code: option.textContent.trim().split(' - ')[0] || ''
                });
            }
        }
        console.log('Loaded companies:', companies.length, companies);
        
        // 既に選択されている値がある場合の表示
        if (companyHidden && companyHidden.value) {
            const selectedCompany = companies.find(c => c.id === companyHidden.value);
            if (selectedCompany) {
                companyInput.value = selectedCompany.name;
            }
        }
    }

    // 検索結果をフィルタリング
    function filterCompanies(query) {
        if (!query.trim()) return [];
        
        const lowerQuery = query.toLowerCase();
        return companies.filter(company => 
            company.name.toLowerCase().includes(lowerQuery) ||
            company.code.toLowerCase().includes(lowerQuery)
        ).slice(0, 10); // 最大10件表示
    }

    // 提案リストを表示
    function showSuggestions(filteredCompanies) {
        companySuggestions.innerHTML = '';
        
        if (filteredCompanies.length === 0) {
            const noResult = document.createElement('div');
            noResult.className = 'suggestion-item text-muted';
            noResult.textContent = '該当する会社が見つかりません';
            companySuggestions.appendChild(noResult);
        } else {
            filteredCompanies.forEach((company, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `<strong>${company.code}</strong> - ${company.name}`;
                item.addEventListener('click', () => selectCompany(company));
                companySuggestions.appendChild(item);
            });
        }
        
        companySuggestions.style.display = 'block';
        selectedIndex = -1;
    }

    // 提案リストを非表示
    function hideSuggestions() {
        companySuggestions.style.display = 'none';
        selectedIndex = -1;
    }

    // 会社を選択
    function selectCompany(company) {
        companyInput.value = company.name;
        if (companyHidden) {
            companyHidden.value = company.id;
        }
        hideSuggestions();
        companyInput.focus();
    }

    // キーボードナビゲーション
    function updateSelection(direction) {
        const items = companySuggestions.querySelectorAll('.suggestion-item:not(.text-muted)');
        if (items.length === 0) return;

        // 前の選択を解除
        items.forEach(item => item.classList.remove('active'));

        // 新しい選択インデックスを計算
        if (direction === 'down') {
            selectedIndex = (selectedIndex + 1) % items.length;
        } else if (direction === 'up') {
            selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
        }

        // 新しい選択を適用
        if (selectedIndex >= 0 && selectedIndex < items.length) {
            items[selectedIndex].classList.add('active');
        }
    }

    // イベントリスナーを設定
    if (companyInput && companySuggestions && companySelect) {
        console.log('Setting up event listeners...');
        companyInput.addEventListener('input', function() {
            const query = this.value;
            console.log('Input event triggered, query:', query);
            const filteredCompanies = filterCompanies(query);
            console.log('Filtered companies:', filteredCompanies);
            
            if (query.trim()) {
                showSuggestions(filteredCompanies);
            } else {
                hideSuggestions();
                if (companyHidden) {
                    companyHidden.value = '';
                }
            }
        });

        companyInput.addEventListener('focus', function() {
            const query = this.value;
            if (query.trim()) {
                const filteredCompanies = filterCompanies(query);
                showSuggestions(filteredCompanies);
            }
        });

        companyInput.addEventListener('keydown', function(e) {
            const items = companySuggestions.querySelectorAll('.suggestion-item:not(.text-muted)');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                updateSelection('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                updateSelection('up');
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < items.length) {
                    const selectedItem = items[selectedIndex];
                    const company = companies.find(c => 
                        selectedItem.textContent.includes(c.name)
                    );
                    if (company) {
                        selectCompany(company);
                    }
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // 外部クリックで提案リストを非表示
        document.addEventListener('click', function(e) {
            if (!companyInput.contains(e.target) && !companySuggestions.contains(e.target)) {
                hideSuggestions();
            }
        });

        // ドロップダウンメニューのイベントリスナー
        const companyOptions = document.querySelectorAll('.company-option');
        companyOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                const company = {
                    id: this.getAttribute('data-id'),
                    name: this.getAttribute('data-name'),
                    code: this.getAttribute('data-code')
                };
                selectCompany(company);
                
                // ドロップダウンを閉じる
                const dropdown = bootstrap.Dropdown.getInstance(document.getElementById('company-dropdown-btn'));
                if (dropdown) {
                    dropdown.hide();
                }
            });
        });

        // 初期化実行
        loadCompanies();
    } else {
        console.error('Required elements not found for autocomplete');
    }
}

// イベントリスナーを追加
document.addEventListener('DOMContentLoaded', function() {
    const amountField = document.getElementById('{{ form.amount.id_for_label }}');
    const taxField = document.getElementById('{{ form.tax_amount.id_for_label }}');
    
    amountField.addEventListener('input', updateTotal);
    taxField.addEventListener('input', updateTotal);
    
    // 初期表示
    updateTotal();
    
    // オートコンプリート機能を初期化
    initializeCompanyAutocomplete();
});
</script>
{% endblock %}
